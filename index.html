<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Toán Thầy Hà </title>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']]
      }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .nav-btn { transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        .nav-btn-answered { background-color: #16a34a; color: white; border-color: #15803d; }
        .nav-btn-current { background-color: #4f46e5; color: white; border-color: #4338ca; transform: scale(1.05); }
        .mcq-label-selected { background-color: #e0e7ff; border-color: #6366f1; }
        @keyframes blinkingColors {
            0%,100% { color: #22c55e; } 33% { color: #ef4444; } 66% { color: #eab308; }
        }
        .blinking-text { animation: blinkingColors 3s infinite; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div id="main-container" class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6">
        <h1 class="text-2xl font-bold text-center mb-6 blinking-text">Lớp Toán Thầy Hà</h1>

        <div id="userInfoSection" class="max-w-md mx-auto">
	<div class="mb-4">
                <label class="block font-bold text-center text-blue-600">Mã kỳ thi (Kiểm tra)</label>
                <p id="examCodeDisplay" class="w-full text-center text-lg font-bold text-red-600 p-2 mt-1"></p>
            </div>
            <h2 class="text-xl font-bold text-center mb-4">Thông tin thí sinh</h2>
            

            <div class="mb-3">
                <label class="block font-medium">Số báo danh (VD: 530112)</label>
                <input type="text" id="studentId" class="w-full border rounded px-3 py-2 mt-1" required>
            </div>
            <div class="mb-3">
                <label class="block font-medium">Họ và tên (VD: Nguyễn Văn Hà)</label>
                <input type="text" id="fullname" class="w-full border rounded px-3 py-2 mt-1" required>
            </div>
            <div class="mb-3">
                <label class="block font-medium">Lớp (VD: 11A1, 11A12)</label>
                <input type="text" id="className" class="w-full border rounded px-3 py-2 mt-1" required>
            </div>
            <div class="mb-3">
    	<label class="block font-medium">Trường</label>
  	 <select id="schoolSelect" class="w-full border rounded px-3 py-2 mt-1">
        <option value="">-- Chọn trường --</option>
        <option value="THPT Yên Dũng số 1">THPT Yên Dũng số 1</option>
        <option value="THPT Yên Dũng số 2">THPT Yên Dũng số 2</option>
        <option value="THPT Yên Dũng số 3">THPT Yên Dũng số 3</option>
        <option value="CĐ nghề Việt – Hàn BN">CĐ nghề Việt – Hàn BN</option>
        <option value="Khác">Khác...</option>
    	</select>
    	<input type="text" id="schoolInput" class="w-full border rounded px-3 py-2 mt-2 hidden" placeholder="Nhập tên trường khác">
	</div>

            <button id="startBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded mt-2">Bắt đầu làm bài</button>
        </div>

        <div id="quizSection" class="hidden">
            <div id="quiz-header" class="flex justify-between items-start border-b pb-4 mb-4">
                <div>
                    <h2 id="quiz-part-title" class="text-xl md:text-2xl font-bold text-gray-800"></h2>
                    <p class="text-lg font-semibold text-blue-600">
                        Câu <span id="question-counter">1</span> / <span id="total-questions-display"></span>
                    </p>
                </div>
                <div>
                    <div id="timer" class="text-2xl font-bold text-red-500">00:00</div>
                    <div id="timeHint" class="text-sm text-gray-500 text-right">Thời gian làm bài</div>
                </div>
            </div>

            <div id="questionNavPanel" class="flex flex-wrap gap-2 p-3 border-b mb-4 bg-gray-50 rounded-lg"></div>

            <form id="quizForm" class="space-y-6">
                <p id="question-text" class="text-lg font-medium text-gray-800 min-h-[48px]"></p>
                <div id="answer-container" class="space-y-3"></div>

                <div class="flex justify-between items-center pt-4 mt-4 border-t">
                    <button type="button" id="prevBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded">Câu trước</button>
                    <div class="flex gap-3">
                        <button type="button" id="reviewTimeBtn" class="bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-2 rounded">Xem bộ thời gian</button>
                        <button type="submit" id="submitBtn" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded text-lg font-bold">Nộp bài</button>
                    </div>
                    <button type="button" id="nextBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded">Câu sau</button>
                </div>
            </form>
        </div>

        <div id="countdown" class="text-red-600 font-bold text-lg my-2"></div>

        <div id="resultSection" class="hidden text-center">
            <h2 id="studentNameResult" class="text-2xl font-bold mb-2"></h2>
            <p class="text-lg mb-4">Đã hoàn thành bài kiểm tra!</p>
            <p class="text-blue-600 font-bold text-lg my-2">Tổng điểm của bạn là: 
                <span id="finalScore" class="font-bold text-blue-600 text-3xl"></span>
            </p>
            <p class="mt-4 text-gray-600">Kết quả đã được lưu vào hệ thống.</p>
            <p class="text-red-600 font-bold text-lg my-2">Liên hệ 0988.948.882 để tham gia lớp học!</p>

        </div>
    </div>

    <!-- Modal quảng cáo / xác nhận vào thi -->
    <div id="announcementModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-lg w-full text-center">
            <h2 class="text-xl font-bold mb-2">Lớp toán thầy Hà tiếp tục tuyển sinh</h2>
            <p class="text-gray-600 mb-6">
                Ôn luyện kiến thức cơ bản và kiến thức chuyên sâu theo yêu cầu!<br>
	   Kiểm tra, đánh giá, nhận xét định kì 2 lần/tháng!<br>
                Địa chỉ học: Đội 6 - Xuân Phú – Tân Tiến – Bắc Ninh!<br>
                Liên hệ qua Zalo: <strong>0988.948.882</strong>
            </p>
            <div class="flex justify-center gap-4">
                <button id="enterQuizBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-2 rounded">Vào thi</button>
                <button id="exitBtn" class="bg-red-500 hover:bg-red-600 text-white px-8 py-2 rounded">Thoát</button>
            </div>
        </div>
    </div>

    <!-- Modal confirm nộp bài -->
    <div id="confirmSubmitModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full text-center">
            <h3 class="text-lg font-bold mb-3">Bạn có chắc chắn muốn nộp bài không?</h3>
            <p class="mb-4 text-gray-600">Sau khi nộp, bạn không thể sửa đáp án.</p>
            <div class="flex justify-center gap-4">
                <button id="confirmYes" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded">Yes</button>
                <button id="confirmNo" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded">No</button>	
            </div>
        </div>
    </div>

    <!-- Modal xem bộ thời gian -->
    <div id="timeInfoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
            <h3 class="text-lg font-bold mb-3">Bộ thời gian</h3>
            <p class="mb-2"><strong>Mã kỳ thi:</strong> <span id="modalExamCode"></span></p>
            <p class="mb-2"><strong>Giờ mở đề:</strong> <span id="modalStartTime"></span></p>
            <p class="mb-2"><strong>Giờ đóng đề:</strong> <span id="modalDeadline"></span></p>
            <p class="mb-4 text-sm text-gray-600">Thời gian làm bài tính từ lúc bạn nhấn "Vào thi".</p>
            <div class="text-right">
                <button id="closeTimeInfo" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Đóng</button>
            </div>
        </div>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ====== Cấu hình Firebase ======
const firebaseConfig = {
    apiKey: "AIzaSyAwM9_H8PTooz3Nh4MPt9wdtBScIvMC318",
    authDomain: "toanthayha-cd96c.firebaseapp.com",
    projectId: "toanthayha-cd96c",
    storageBucket: "toanthayha-cd96c.firebasestorage.app",
    messagingSenderId: "940207284081",
    appId: "1:940207284081:web:9801158f72cc14053ae0d0",	
    measurementId: "G-9D5ZQ66BSB"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ====== Cấu hình kỳ thi ====== timeend
const EXAM_CODE = "Toan11_002";
const QUIZ_ID = "toanthayha_11";
const TIME_LIMIT_SECONDS = 60 * 60; // thời gian làm bài (giây). chỉnh ở đây
const ATTEMPT_LIMIT = 3;            // giới hạn số lần làm bài mỗi SBD
const START_TIME = "2025-10-09T20:00:00"; // thời gian mở
const DEADLINE = "2025-10-18T23:00:00";   // thời gian đóng

// ====== DOM ======
const examCodeDisplay = document.getElementById("examCodeDisplay");
const startBtn = document.getElementById("startBtn");
const announcementModal = document.getElementById("announcementModal");
const enterQuizBtn = document.getElementById("enterQuizBtn");
const exitBtn = document.getElementById("exitBtn");
const userInfoSection = document.getElementById("userInfoSection");
const quizSection = document.getElementById("quizSection");
const resultSection = document.getElementById("resultSection");
const timerElement = document.getElementById("timer");
const countdownEl = document.getElementById("countdown");
const reviewTimeBtn = document.getElementById("reviewTimeBtn");

const confirmSubmitModal = document.getElementById("confirmSubmitModal");
const confirmYes = document.getElementById("confirmYes");
const confirmNo = document.getElementById("confirmNo");

const timeInfoModal = document.getElementById("timeInfoModal");
const modalExamCode = document.getElementById("modalExamCode");
const modalStartTime = document.getElementById("modalStartTime");
const modalDeadline = document.getElementById("modalDeadline");
const closeTimeInfo = document.getElementById("closeTimeInfo");

const quizForm = document.getElementById("quizForm");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const submitBtn = document.getElementById("submitBtn");
// Xử lý chọn trường
const schoolSelect = document.getElementById("schoolSelect");
const schoolInput = document.getElementById("schoolInput");

schoolSelect.addEventListener("change", () => {
    if (schoolSelect.value === "Khác") {
        schoolInput.classList.remove("hidden");
        schoolInput.value = "";
    } else {
        schoolInput.classList.add("hidden");
        schoolInput.value = schoolSelect.value;
    }
});


// Hiển thị mã kỳ thi
examCodeDisplay.textContent = EXAM_CODE;

// Hiển thị modal thông tin thời gian
modalExamCode.textContent = EXAM_CODE;
modalStartTime.textContent = (new Date(START_TIME)).toLocaleString();
modalDeadline.textContent = (new Date(DEADLINE)).toLocaleString();

reviewTimeBtn.addEventListener("click", () => timeInfoModal.classList.remove("hidden"));
closeTimeInfo.addEventListener("click", () => timeInfoModal.classList.add("hidden"));

// === Countdown mở/đóng đề ===
function formatDiff(ms) {
    if (ms < 0) ms = 0;
    const totalSeconds = Math.floor(ms / 1000);
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    return `${h}h ${m}m ${s}s`;
}
function updateCountdown() {
    const now = new Date();
    const startDate = new Date(START_TIME);
    const endDate = new Date(DEADLINE);
    let msg = "";
    if (now < startDate) {
        msg = "⏳ Bài kiểm tra sẽ mở sau: " + formatDiff(startDate - now);
    } else if (now >= startDate && now <= endDate) {
        msg = "📝 Bài kiểm tra đang mở. Hãy làm thêm lần nữa nếu còn lượt. Còn thời gian tới khi đóng đề: " + formatDiff(endDate - now);
    } else {
        msg = "❌ Bài kiểm tra đã kết thúc.";
        startBtn.disabled = true;
        startBtn.textContent = "Đã hết hạn làm bài";
        startBtn.classList.add('bg-gray-400','cursor-not-allowed');
    }
    countdownEl.textContent = msg;
}
setInterval(updateCountdown, 1000);
updateCountdown();

// nhapcauhoi
const originalQuizData = [{
"part": "Phần I: Câu trắc nghiệm nhiều phương án lựa chọn",
"type": "mcq",
"question": "Trong các dãy số sau, dãy số nào là một cấp số cộng?",
"o": ["$1,\\,2,\\,4,\\,8,\\,16,...$ .", "$1,\\,3,\\,9,\\,27,\\,81,...$ .", "$2,\\,5,\\,8,\\,11,\\,14,\\,17,...$ .", "$-1,\\,-5,\\,-25,\\,-125,\\,-625,...$ ."],
"a": "$2,\\,5,\\,8,\\,11,\\,14,\\,17,...$ ."
},
{
"part": "Phần I: Câu trắc nghiệm nhiều phương án lựa chọn",
"type": "mcq",
"question": "Cho cấp số cộng  $\\left( {{u}_{n}} \\right)$  có số hạng đầu  ${{u}_{1}}=2$ , công sai  $d=5$ . Giá trị của ${{u}_{4}}$ bằng",
"o": ["$22$ .", "$17$ .", "$~12$ .", "$250$ ."],
"a": "$17$ ."
},
{
"part": "Phần I: Câu trắc nghiệm nhiều phương án lựa chọn",
"type": "mcq",
"question": "Dãy số $\\left( {{u}_{n}} \\right)$nào sau đây là dãy số tăng?",
"o": ["${{u}_{n}}={{3}^{-n}}+1$.", "${{u}_{n}}=\\sin n$.", "${{u}_{n}}=2n-3$.", "${{u}_{n}}=\\frac{n+2}{n+1}$."],
"a": "${{u}_{n}}=2n-3$."
},
{
"part": "Phần I: Câu trắc nghiệm nhiều phương án lựa chọn",
"type": "mcq",
"question": "Ba góc của một tam giác vuông tạo thành cấp số cộng. Hai góc nhọn của tam giác có số đo (độ) là",
"o": ["$20{}^\\circ $ và $70{}^\\circ .$", "$45{}^\\circ $ và $45{}^\\circ .$", "$20{}^\\circ $ và $45{}^\\circ .$", "$30{}^\\circ $ và $60{}^\\circ .$"],
"a": "$30{}^\\circ $ và $60{}^\\circ .$"
},
{
"part": "Phần I: Câu trắc nghiệm nhiều phương án lựa chọn",
"type": "mcq",
"question": "Cho một cấp số cộng có ${{u}_{3}}=-15$, ${{u}_{20}}=60$. Tổng của $20$ số hạng đầu tiên của cấp số cộng là",
"o": ["$200$.", "$250$.", "$-25$.", "$-200$."],
"a": "$250$."
},
{
"part": "Phần I: Câu trắc nghiệm nhiều phương án lựa chọn",
"type": "mcq",
"question": "Cho dãy số $\\left( {{x}_{n}} \\right)$thỏa mãn  ${{x}_{1}}+{{x}_{2}}+...+{{x}_{n}}=\\frac{3n\\left( n+3 \\right)}{2}$ với mọi  $n\\in \\mathbb{N}*$ . Khẳng định nào dưới đây là đúng và đầy đủ nhất.",
"o": ["$\\left( {{x}_{n}} \\right)$là cấp số cộng với công sai âm.", "$\\left( {{x}_{n}} \\right)$là cấp số nhân với công bội âm.", "$\\left( {{x}_{n}} \\right)$là cấp số cộng với công sai dương.", "$\\left( {{x}_{n}} \\right)$là cấp số nhân với công bội dương."],
"a": "$\\left( {{x}_{n}} \\right)$là cấp số cộng với công sai dương."
},
{
"part": "Phần I: Câu trắc nghiệm nhiều phương án lựa chọn",
"type": "mcq",
"question": "Cho cấp số nhân $\\left( {{u}_{n}} \\right)$ có ${{u}_{1}}\\ne 0$ và $q\\ne 0.$ Đẳng thức nào sau đây là đúng?",
"o": ["${{u}_{7}}={{u}_{4}}.{{q}^{3}}.$", "${{u}_{7}}={{u}_{4}}.{{q}^{4}}.$", "${{u}_{7}}={{u}_{4}}.{{q}^{5}}.$", "${{u}_{7}}={{u}_{4}}.{{q}^{6}}.$"],
"a": "${{u}_{7}}={{u}_{4}}.{{q}^{6}}.$"
},
{
"part": "Phần I: Câu trắc nghiệm nhiều phương án lựa chọn",
"type": "mcq",
"question": "Cho dãy số  $\\left( {{u}_{n}} \\right)$  với  ${{u}_{n}}=\\frac{3}{2}{{.5}^{n}}$ . Khẳng định nào sau đây đúng?",
"o": ["$\\left( {{u}_{n}} \\right)$  là cấp số nhân có công bội  $q=5$  và số hạng đầu  ${{u}_{1}}=\\frac{15}{2}$ .", "$\\left( {{u}_{n}} \\right)$  là cấp số cộng có công sai  $d=5$  và số hạng đầu  ${{u}_{1}}=\\frac{3}{2}$ .", "$\\left( {{u}_{n}} \\right)$  là cấp số nhân có công bội  $q=5$  và số hạng đầu  ${{u}_{1}}=\\frac{3}{2}$ .", "$\\left( {{u}_{n}} \\right)$  không phải là cấp số nhân."],
"a": "$\\left( {{u}_{n}} \\right)$  là cấp số nhân có công bội  $q=5$  và số hạng đầu  ${{u}_{1}}=\\frac{15}{2}$ ."
},
{
"part": "Phần I: Câu trắc nghiệm nhiều phương án lựa chọn",
"type": "mcq",
"question": "Cho cấp số nhân $\\left( {{u}_{n}} \\right)$ có ${{u}_{2}}=-6$ và ${{u}_{6}}=-486.$ Tìm công bội $q$ của cấp số nhân đã cho, biết rằng ${{u}_{3}}<0$.",
"o": ["$q=-3.$", "$q=-\\frac{1}{3}.$", "$q=\\frac{1}{3}.$", "$q=3.$"],
"a": "$q=3.$"
},
{
"part": "Phần I: Câu trắc nghiệm nhiều phương án lựa chọn",
"type": "mcq",
"question": "Cho dãy số $\\left( {{u}_{n}} \\right)$ xác định bởi ${{u}_{n}}=9-2n$. Mệnh đề nào dưới đây đúng?",
"o": ["$\\left( {{u}_{n}} \\right)$  là dãy giảm và bị chặn trên.", "$\\left( {{u}_{n}} \\right)$  tăng.", "$\\left( {{u}_{n}} \\right)$  là dãy giảm và bị chặn dưới.", "$\\left( {{u}_{n}} \\right)$  bị chặn."],
"a": "$\\left( {{u}_{n}} \\right)$  là dãy giảm và bị chặn trên."
},
{
"part": "Phần II: Câu trắc nghiệm đúng sai",
"type": "true-false",
"question": "Cho cấp số cộng $\\left( {{u}_{n}} \\right)$ với ${{u}_{1}}+{{u}_{3}}=6$ và $2{{u}_{2}}-{{u}_{4}}=-5$. Đồng thời cho dãy số dãy số $\\left( {{v}_{n}} \\right)$ có số hạng tổng quát ${{v}_{n}}=u_{n}^{2}-16{{n}^{2}}$. Xét tính đúng sai của các mệnh đề sau:",
"s": [
{"text": "Số hạng đầu của cấp số cộng $\\left( {{u}_{n}} \\right)$ là ${{u}_{1}}=3$.", "a": true},
{"text": "Công sai của cấp số cộng $\\left( {{u}_{n}} \\right)$ là một số dương.", "a": false},
{"text": "Tổng của 20 số hạng đầu của cấp số cộng $\\left( {{u}_{n}} \\right)$ bằng $1480$.", "a": true},
{"text": "Dãy số $\\left( {{v}_{n}} \\right)$ là cấp số cộng có công sai là $d=-20$.", "a": true}
]
},
{
"part": "Phần II: Câu trắc nghiệm đúng sai",
"type": "true-false",
"question": "Cho cấp số cộng $\\left( {{u}_{n}} \\right)$, có số hạng đầu ${{u}_{1}}=\\frac{3}{2}$, công sai $d=\\frac{1}{2}$. Khi đó các mệnh đề dưới đây đúng hay sai ?",
"s": [
{"text": "Công thức số hạng tổng quát của cấp số cộng đã cho là ${{u}_{n}}=1+\\frac{n}{3}$", "a": false},
{"text": "Số 5 là số hạng thứ 8 của cấp số cộng đã cho.", "a": true},
{"text": "Số $\\frac{15}{4}$ là một số hạng của cấp số cộng đã cho.", "a": false},
{"text": "Tổng $100$ số hạng đầu của của cấp số cộng $({{u}_{n}})$ trên bằng $2620$", "a": false}
]
},
{
"part": "Phần II: Câu trắc nghiệm đúng sai",
"type": "true-false",
"question": "Cho dãy số $\\left( {{u}_{n}} \\right)\\,$ thỏa mãn ${{u}_{1}}=1,\\,\\,{{u}_{n+1}}={{u}_{n}}+n\\,\\forall n\\in {{\\mathbb{N}}^{*}}$",
"s": [
{"text": "Dãy số đã cho là dãy số tăng.", "a": true},
{"text": "Dãy số đã cho là dãy số bị chặn.", "a": false},
{"text": "${{u}_{8}}=29$", "a": true},
{"text": "Dãy đã cho là một cấp số cộng.", "a": false}
]
},
{
"part": "Phần III: Câu trắc nghiệm trả lời ngắn",
"type": "short-answer",
"question": "Ba số $a,b,c$ khác $0$ theo thứ tự đó lập thành một cấp số cộng có công sai dương. Nếu cộng thêm vào số hạng thứ ba 9 đơn vị thì ta thu được dãy số mới theo thứ tự đó lập thành một cấp số nhân. Nếu ta tiếp tục nhân số hạng thứ 2 và thứ 3 của cấp số nhân này với $\\frac{-1}{8}$ ta lại thu được dãy số mới theo thứ tự đó lập thành cấp số cộng. Tính giá trị biểu thức $P=a+2b+3c$.",
"a": "30"
},
{
"part": "Phần III: Câu trắc nghiệm trả lời ngắn",
"type": "short-answer",
"question": "Cho cấp số nhân $\\left( {{u}_{n}} \\right)$với ${{u}_{1}}=2,\\,{{u}_{4}}=54.$ Giá trị của số hạng thứ 8 bằng bao nhiêu?",
"a": "4374"
},
{
"part": "Phần III: Câu trắc nghiệm trả lời ngắn",
"type": "short-answer",
"question": "Quá trình phân bào là một quá trình sinh học mà ở đó, từ một tế bào ban đầu, sau mỗi lần phân bào thì tế bào đó được tách thành hai tế bào mới riêng biệt. Các tế bào mới đó lại tiếp tục phân bào để tạo ra những tế bào mới. Từ một tế bào nấm mốc, sau 6 lần phân bào sẽ tạo ra bao nhiêu tế bào?",
"a": "64"
},
{
"part": "Phần III: Câu trắc nghiệm trả lời ngắn",
"type": "short-answer",
"question": "Người ta trồng  $2145$  cây theo hình một tam giác như sau: hàng thứ nhất có  $1$  cây, hàng thứ hai có  $2$  cây, hàng thứ ba có 3 cây,… Hỏi có tất cả bao nhiêu hàng cây?",
"a": "65"
}
];
let quizData = [];
const totalQuestions = originalQuizData.length;
document.getElementById("total-questions-display").textContent = totalQuestions;

// ========== Trạng thái thi ==========
let currentUser = null;
let quizStartTime = null;
let timerInterval = null;
let timeLeftSeconds = TIME_LIMIT_SECONDS;
let currentQuestionIndex = 0;
let userAnswers = new Array(totalQuestions).fill(null);

// === Utility ===
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}
function prepareShuffledQuiz() {
    // Giữ phân loại theo 'part' giống gốc, nhưng shuffle trong mỗi part
    const grouped = originalQuizData.reduce((acc, q) => {
        acc[q.part] = acc[q.part] || [];
        acc[q.part].push(q);
        return acc;
    }, {});
    let res = [];
    for (const part in grouped) {
        shuffleArray(grouped[part]);
        res = res.concat(grouped[part]);
    }
    return res;
}

// ========== Kiểm tra số lần thi trước khi vào ==========
startBtn.addEventListener("click", async () => {
    const now = new Date();
    const startDate = new Date(START_TIME);
    const endDate = new Date(DEADLINE);

    if (now < startDate) {
        alert(`Bài kiểm tra chỉ mở từ ${startDate.toLocaleString('vi-VN')}. Vui lòng quay lại sau.`);
        return;
    }
    if (now > endDate) {
        alert(`Bài kiểm tra đã kết thúc vào lúc ${endDate.toLocaleString('vi-VN')}. Không thể nhận thêm bài làm.`);
        return;
    }

    const studentId = document.getElementById("studentId").value.trim();
    const fullname = document.getElementById("fullname").value.trim();
    const className = document.getElementById("className").value.trim();
    const school = document.getElementById("schoolInput").value.trim();


    if (!studentId || !fullname || !className || !school) {
        alert("Vui lòng nhập đầy đủ thông tin!");
        return;
    }

    // Kiểm tra số lần làm bài với Firestore
    try {
        const resultsRef = collection(db, "quizResults");
        const q = query(resultsRef,
            where("studentId", "==", studentId),
            where("examCode", "==", EXAM_CODE),
            where("quizId", "==", QUIZ_ID)
        );
        const snapshot = await getDocs(q);
        if (snapshot.size >= ATTEMPT_LIMIT) {
            alert(`Số báo danh ${studentId} đã hết số lượt làm bài (${ATTEMPT_LIMIT} lần).`);
            return;
        }
    } catch (err) {
        console.error("Lỗi kiểm tra lượt thi:", err);
        alert("Lỗi kiểm tra số lượt thi. Vui lòng thử lại hoặc kiểm tra kết nối.");
        return;
    }

    // lưu thông tin tạm và hiện modal quảng cáo
    currentUser = { examCode: EXAM_CODE, studentId, fullname, className, school };
    announcementModal.classList.remove("hidden");
});

// ========== Vào thi sau modal ==========
enterQuizBtn.addEventListener("click", () => {
    announcementModal.classList.add("hidden");
    userInfoSection.classList.add("hidden");
    quizSection.classList.remove("hidden");

    // chuẩn bị đề, biến trạng thái
    quizData = prepareShuffledQuiz();
    userAnswers = new Array(totalQuestions).fill(null);
    currentQuestionIndex = 0;
    quizStartTime = Date.now();
    timeLeftSeconds = TIME_LIMIT_SECONDS;

    renderNavPanel();
    jumpToQuestion(0);
    startTimer();
});

exitBtn.addEventListener("click", () => {
    announcementModal.classList.add("hidden");
});

// ========== Timer làm bài ==========
function startTimer() {
    // hiển thị lần đầu
    updateTimerDisplay(timeLeftSeconds);

    // clear nếu còn
    if (timerInterval) clearInterval(timerInterval);

    timerInterval = setInterval(() => {
        timeLeftSeconds--;
        if (timeLeftSeconds <= 0) {
            clearInterval(timerInterval);
            // tự động nộp mà KHÔNG hiển thị confirm
            alert("⏰ Hết giờ! Bài thi sẽ được nộp tự động.");
            submitQuiz(true); // auto = true
        } else {
            updateTimerDisplay(timeLeftSeconds);
        }
    }, 1000);
}
function updateTimerDisplay(seconds) {
    const min = Math.floor(seconds / 60).toString().padStart(2, '0');
    const sec = (seconds % 60).toString().padStart(2, '0');
    timerElement.textContent = `${min}:${sec}`;
}

// ========== Điều hướng câu hỏi ==========
function renderNavPanel() {
    questionNavPanel.innerHTML = '';
    for (let i = 0; i < totalQuestions; i++) {
        const btn = document.createElement('button');
        btn.textContent = i + 1;
        btn.className = 'nav-btn w-10 h-10 border rounded font-medium';
        btn.type = 'button';
        btn.onclick = () => {
            saveCurrentAnswer();
            jumpToQuestion(i);
        };
        questionNavPanel.appendChild(btn);
    }
}
function jumpToQuestion(index) {
    currentQuestionIndex = index;
    showQuestion();
    updateNavPanel();
}
function showQuestion() {
    const q = quizData[currentQuestionIndex];
    document.getElementById("quiz-part-title").textContent = q.part || "";
    document.getElementById("question-counter").textContent = currentQuestionIndex + 1;
    document.getElementById("question-text").innerHTML = q.question || "";
    answerContainer.innerHTML = "";

    switch (q.type) {
        case 'mcq': renderMCQ(q); break;
        case 'true-false': renderTrueFalse(q); break;
        case 'short-answer': renderShortAnswer(q); break;
        default: renderMCQ(q);
    }

    if (window.MathJax && MathJax.typesetPromise) {
        MathJax.typesetPromise();
    }

    prevBtn.classList.toggle('hidden', currentQuestionIndex === 0);
    nextBtn.classList.toggle('hidden', currentQuestionIndex === totalQuestions - 1);
}
function updateNavPanel() {
    const navs = questionNavPanel.children;
    for (let i = 0; i < navs.length; i++) {
        navs[i].classList.remove('nav-btn-current', 'nav-btn-answered');
        if (userAnswers[i] !== null) navs[i].classList.add('nav-btn-answered');
        if (i === currentQuestionIndex) navs[i].classList.add('nav-btn-current');
    }
}

// ========== Lưu đáp án khi chuyển câu ==========
function saveCurrentAnswer() {
    const q = quizData[currentQuestionIndex];
    if (!q) return;
    let ans = null;
    switch (q.type) {
        case 'mcq':
            const sr = quizForm.querySelector(`input[name="q${currentQuestionIndex}"]:checked`);
            if (sr) ans = sr.value;
            break;
        case 'true-false':
            ans = [];
            for (let i = 0; i < q.s.length; i++) {
                const sr2 = quizForm.querySelector(`input[name="q${currentQuestionIndex}s${i}"]:checked`);
                ans.push(sr2 ? (sr2.value === 'true') : null);
            }
            if (ans.every(x => x === null)) ans = null;
            break;
        case 'short-answer':
            const inp = quizForm.querySelector(`input[name="q${currentQuestionIndex}"]`);
            if (inp && inp.value.trim() !== "") ans = inp.value.trim();
            break;
    }
    userAnswers[currentQuestionIndex] = ans;
    updateNavPanel();
}

// ========== Render các loại câu hỏi ==========
function renderMCQ(question) {
    const saved = userAnswers[currentQuestionIndex];
    const options = [...question.o];
    options.forEach(option => {
        const div = document.createElement('div');
        const label = document.createElement('label');
        label.className = "flex items-center p-3 rounded-lg border cursor-pointer hover:bg-gray-50";

        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = `q${currentQuestionIndex}`;
        radio.value = option;
        radio.className = 'mr-3';
        if (saved === option) {
            radio.checked = true;
            label.classList.add('mcq-label-selected');
        }
        radio.addEventListener('change', () => {
            answerContainer.querySelectorAll('label').forEach(l => l.classList.remove('mcq-label-selected'));
            label.classList.add('mcq-label-selected');
            saveCurrentAnswer();
        });

        const span = document.createElement('span');
        span.innerHTML = option;

        label.appendChild(radio);
        label.appendChild(span);
        div.appendChild(label);
        answerContainer.appendChild(div);
    });
}

function renderTrueFalse(question) {
    const saved = userAnswers[currentQuestionIndex] || [];
    question.s.forEach((st, sIndex) => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-3 border rounded-lg';

        const span = document.createElement('span');
        span.innerHTML = st.text;

        const group = document.createElement('div');
        group.className = 'flex gap-4';

        const trueLabel = document.createElement('label');
        trueLabel.className = 'cursor-pointer flex items-center';
        const tRadio = document.createElement('input');
        tRadio.type = 'radio';
        tRadio.name = `q${currentQuestionIndex}s${sIndex}`;
        tRadio.value = 'true';
        tRadio.className = 'mr-2';
        if (saved[sIndex] === true) tRadio.checked = true;
        tRadio.addEventListener('change', saveCurrentAnswer);
        trueLabel.appendChild(tRadio);
        trueLabel.append(' Đúng');

        const falseLabel = document.createElement('label');
        falseLabel.className = 'cursor-pointer flex items-center';
        const fRadio = document.createElement('input');
        fRadio.type = 'radio';
        fRadio.name = `q${currentQuestionIndex}s${sIndex}`;
        fRadio.value = 'false';
        fRadio.className = 'mr-2';
        if (saved[sIndex] === false) fRadio.checked = true;
        fRadio.addEventListener('change', saveCurrentAnswer);
        falseLabel.appendChild(fRadio);
        falseLabel.append(' Sai');

        group.appendChild(trueLabel);
        group.appendChild(falseLabel);
        div.appendChild(span);
        div.appendChild(group);
        answerContainer.appendChild(div);
    });
}

function renderShortAnswer(question) {
    const saved = userAnswers[currentQuestionIndex] || '';
    const input = document.createElement('input');
    input.type = 'text';
    input.name = `q${currentQuestionIndex}`;
    input.className = 'w-full border rounded px-3 py-2 mt-2';
    input.placeholder = "Nhập đáp án";
    input.value = saved;
    input.addEventListener('input', saveCurrentAnswer);
    answerContainer.appendChild(input);
}

// ========== Điều khiển prev/next ==========
prevBtn.addEventListener('click', () => {
    saveCurrentAnswer();
    if (currentQuestionIndex > 0) jumpToQuestion(currentQuestionIndex - 1);
});
nextBtn.addEventListener('click', () => {
    saveCurrentAnswer();
    if (currentQuestionIndex < totalQuestions - 1) jumpToQuestion(currentQuestionIndex + 1);
});

// ========== Xử lý nộp bài (có modal confirm) ==========
let isAutoSubmit = false; // nếu gọi bởi timeout thì true

quizForm.addEventListener("submit", (e) => {
    e.preventDefault();
    // Nếu đang auto-submit do hết giờ thì submit ngay
    if (isAutoSubmit) {
        isAutoSubmit = false;
        submitQuiz(true);
        return;
    }
    // else show confirm modal
    confirmSubmitModal.classList.remove('hidden');
});

// khi user xác nhận Yes
confirmYes.addEventListener('click', () => {
    confirmSubmitModal.classList.add('hidden');
    submitQuiz(false);
});
confirmNo.addEventListener('click', () => {
    confirmSubmitModal.classList.add('hidden');
    // không nộp
});

// submitQuiz thực tế (auto=true khi do hết giờ)
async function submitQuiz(auto = false) {
    // lưu answer hiện tại
    saveCurrentAnswer();
    if (timerInterval) clearInterval(timerInterval);

    // tính thời gian làm bài
    const timeTakenSeconds = Math.round((Date.now() - quizStartTime) / 1000);
    // tinhdiem 
    let totalScore = 0;
    const answersToSave = {};
    quizData.forEach((q, idx) => {
        const ua = userAnswers[idx];
        answersToSave[`q${idx+1}`] = ua;
        if (ua === null) return;
        switch (q.type) {
            case 'mcq':
                if (ua === q.a) totalScore += 0.5;
                break;
            case 'true-false':
                let correctCount = 0;
                q.s.forEach((st, sIndex) => { if (ua[sIndex] === st.a) correctCount++; });
                const pointsMap = [0, 0.1, 0.25, 0.5, 1];
                totalScore += pointsMap[correctCount] || 0;
                break;
            case 'short-answer':
                if (typeof ua === 'string' && ua.toLowerCase() === String(q.a).toLowerCase()) totalScore += 0.5;
                break;
        }
    });

    // ẩn quiz, hiện kết quả
    quizSection.classList.add('hidden');
    resultSection.classList.remove('hidden');
    document.getElementById("studentNameResult").textContent = currentUser.fullname || "";

    document.getElementById("finalScore").textContent = totalScore.toFixed(2);

    // lưu lên Firestore
    try {
        await addDoc(collection(db, "quizResults"), {
            ...currentUser,
            quizId: QUIZ_ID,
            examCode: EXAM_CODE,
            score: parseFloat(totalScore.toFixed(2)),
            totalPossibleScore: totalQuestions * 0.5, // giả sử mỗi câu 0.5 max
            timeTaken: timeTakenSeconds,
            answers: answersToSave,
            submittedAt: serverTimestamp()
        });
    } catch (err) {
        console.error("Lỗi khi lưu kết quả:", err);
        alert("Đã có lỗi khi lưu kết quả. Vui lòng thử lại hoặc liên hệ quản trị.");
    }
}

// Nếu timer hết giờ gọi submitQuiz(true)
function autoSubmitNow() {
    isAutoSubmit = true;
    quizForm.requestSubmit(); // sẽ trigger submit listener và auto xử lý
}

// ========== Khởi tạo vùng answerContainer tham chiếu ==========
const answerContainer = document.getElementById("answer-container");
const questionNavPanel = document.getElementById("questionNavPanel");

// === khi đóng trang dọn dẹp ===
window.addEventListener('beforeunload', () => {
    if (timerInterval) clearInterval(timerInterval);
});
// ====== Tự động lấy thông tin học sinh từ Google Sheet ======
const studentIdInput = document.getElementById("studentId");
const fullnameInput = document.getElementById("fullname");
const classNameInput = document.getElementById("className");

const API_URL = "https://script.google.com/macros/s/AKfycbxyg8Vvc7BO9kAl_K0OJ488Xxx6C-tG_CXaxx44owA/dev"; // đổi link này thành link web app bạn deploy

studentIdInput.addEventListener("blur", async () => {
    const id = studentIdInput.value.trim();
    if (!id) return;

    try {
        const res = await fetch(`${API_URL}?id=${id}`);
        const data = await res.json();

        if (data && data.studentId) {
            fullnameInput.value = data.fullname || "";
            classNameInput.value = data.className || "";
            schoolSelect.value = data.school || "";
            schoolInput.value = data.school || "";

            if (!schoolSelect.querySelector(`option[value="${data.school}"]`)) {
                schoolSelect.value = "Khác";
                schoolInput.classList.remove("hidden");
            } else {
                schoolInput.classList.add("hidden");
            }
        } else {
            alert("❌ Không tìm thấy số báo danh này trong danh sách.");
        }
    } catch (err) {
        console.error("Lỗi lấy dữ liệu:", err);
        alert("Lỗi kết nối tới Google Sheet. Vui lòng thử lại.");
    }
});
</script>
</body>
</html>

